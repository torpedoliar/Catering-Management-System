// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
  CANTEEN
  VENDOR
}

enum OrderStatus {
  ORDERED
  PICKED_UP
  NO_SHOW
  CANCELLED
}

enum MessageType {
  COMPLAINT     // Customer complaint about food quality
  CANCELLATION  // Cancellation reason before cutoff
}

// Organizational Structure Models
model Company {
  id        String     @id @default(uuid())
  name      String     @unique
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  divisions Division[]

  @@index([name])
}

model Division {
  id        String       @id @default(uuid())
  name      String
  companyId String
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  company     Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  departments Department[]

  @@unique([companyId, name])
  @@index([companyId])
}

model Department {
  id             String   @id @default(uuid())
  name           String
  divisionId     String
  defaultShiftId String?  // Legacy field - will be removed after migration
  workDays       String   @default("1,2,3,4,5") // 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  division       Division          @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  defaultShift   Shift?            @relation("DepartmentDefaultShift", fields: [defaultShiftId], references: [id])
  allowedShifts  DepartmentShift[]
  users          User[]

  @@unique([divisionId, name])
  @@index([divisionId])
}

// Join table for Department-Shift many-to-many relationship
model DepartmentShift {
  id           String   @id @default(uuid())
  departmentId String
  shiftId      String
  createdAt    DateTime @default(now())

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  shift      Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([departmentId, shiftId])
  @@index([departmentId])
  @@index([shiftId])
}

model User {
  id           String      @id @default(uuid())
  externalId   String      @unique // HRIS ID (for login)
  nik          String?     @unique // Company NIK (numeric, for check-in only)
  name         String
  email        String?
  password     String      // Hashed password
  company      String      // Legacy field for display
  division     String      // Legacy field for display
  department   String      // Legacy field for display
  departmentId String?     // Optional reference to Department
  photo        String?     // URL/path to user photo
  role         Role        @default(USER)
  noShowCount  Int         @default(0)
  mustChangePassword Boolean @default(true)
  isActive     Boolean     @default(true)
  preferredCanteenId String? // User's preferred canteen for auto-selection
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  departmentRef      Department? @relation(fields: [departmentId], references: [id])
  preferredCanteen   Canteen?    @relation("UserPreferredCanteen", fields: [preferredCanteenId], references: [id])
  orders             Order[]
  blacklists         Blacklist[]
  messages           Message[]
  announcements      Announcement[]

  @@index([externalId])
  @@index([nik])
  @@index([name])
  @@index([company])
  @@index([departmentId])
  @@index([preferredCanteenId])
  // Composite indexes
  @@index([isActive, role])  // Active users by role query

  // Relation for backups
  backups Backup[]
}

// Backup status enum
enum BackupStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}

// Database backup records
model Backup {
  id          String       @id @default(cuid())
  filename    String
  size        Int          // bytes
  createdAt   DateTime     @default(now())
  createdById String?
  createdBy   User?        @relation(fields: [createdById], references: [id], onDelete: SetNull)
  notes       String?
  status      BackupStatus @default(COMPLETED)

  @@index([createdAt])
  @@index([status])
}

// Canteen location management
model Canteen {
  id          String   @id @default(uuid())
  name        String   @unique
  location    String?  // Optional address/description
  capacity    Int?     // Max daily orders (null = unlimited)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders         Order[]
  canteenShifts  CanteenShift[]
  preferredUsers User[] @relation("UserPreferredCanteen")

  @@index([isActive])
  @@index([name])
}

// Join table for Canteen-Shift availability with optional capacity per shift
model CanteenShift {
  id        String   @id @default(uuid())
  canteenId String
  shiftId   String
  capacity  Int?     // Per-shift capacity (null = use canteen default)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  canteen   Canteen  @relation(fields: [canteenId], references: [id], onDelete: Cascade)
  shift     Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([canteenId, shiftId])
  @@index([canteenId])
  @@index([shiftId])
}

model Shift {
  id          String   @id @default(uuid())
  name        String   @unique // "Shift 1", "Shift 2", "Shift 3"
  startTime   String   // "08:00" format (HH:mm)
  endTime     String   // "15:00" format (HH:mm)
  mealPrice   Decimal  @default(25000) @db.Decimal(12, 2)  // Harga per porsi makanan
  description String?  // Deskripsi menu (opsional)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders           Order[]
  departments      Department[]      @relation("DepartmentDefaultShift")
  departmentShifts DepartmentShift[]
  canteenShifts    CanteenShift[]
  holidays         Holiday[]
  messages         Message[]
}

model Order {
  id            String      @id @default(uuid())
  userId        String
  shiftId       String
  orderDate     DateTime    // Date of the order (current day only)
  orderTime     DateTime    @default(now())
  status        OrderStatus @default(ORDERED)
  qrCode        String      @unique
  mealPrice     Decimal?    @db.Decimal(12, 2)  // Harga makanan saat order dibuat (historical price)
  checkInTime   DateTime?
  checkedInById String?     // ID of admin/canteen staff who processed check-in
  checkedInBy   String?     // Name of admin/canteen staff (denormalized for quick display)
  cancelledById String?     // ID of user who cancelled the order
  cancelledBy   String?     // Name of user who cancelled (denormalized)
  cancelReason  String?     // Reason for cancellation
  checkinPhoto  String?     // Photo taken during check-in
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  canteenId     String?     // Canteen location for this order

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  shift       Shift       @relation(fields: [shiftId], references: [id])
  canteen     Canteen?    @relation(fields: [canteenId], references: [id])
  messages    Message[]

  @@index([userId])
  @@index([shiftId])
  @@index([canteenId])
  @@index([orderDate])
  @@index([status])
  @@index([qrCode])
  @@index([checkedInById])
  // Composite indexes for common query patterns
  @@index([orderDate, status])         // Dashboard filtering by date and status
  @@index([userId, orderDate])         // User's orders by date
  @@index([shiftId, orderDate, status]) // Shift orders on specific date
  @@index([canteenId, orderDate, status]) // Canteen orders on specific date
}

model Blacklist {
  id        String    @id @default(uuid())
  userId    String
  reason    String
  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
  // Composite index for checking active blacklists
  @@index([userId, isActive, endDate])
}

model Settings {
  id                 String @id @default("default")
  
  // Cutoff Mode Selection
  cutoffMode         String @default("per-shift")  // "per-shift" | "weekly"
  
  // MODE 1: Per-Shift Cutoff (existing)
  cutoffDays         Int    @default(0)      // Days before shift to stop orders
  cutoffHours        Int    @default(6)      // Hours before shift to stop orders (0-23)
  maxOrderDaysAhead  Int    @default(7)      // Maximum days in advance for ordering
  
  // MODE 2: Weekly Cutoff (new)
  weeklyCutoffDay    Int    @default(5)      // 0=Sun, 1=Mon, ..., 5=Fri, 6=Sat
  weeklyCutoffHour   Int    @default(17)     // Hour 0-23
  weeklyCutoffMinute Int    @default(0)      // Minute 0-59
  orderableDays      String @default("1,2,3,4,5,6")  // CSV: weekdays that can be ordered (1=Mon, 6=Sat)
  maxWeeksAhead      Int    @default(1)      // 1 or 2 weeks ahead
  
  // Blacklist Settings
  blacklistStrikes   Int    @default(3)      // No-shows before blacklist
  blacklistDuration  Int    @default(7)      // Days of blacklist

  
  // NTP Settings
  ntpEnabled         Boolean @default(true)  // Enable NTP sync
  ntpServer          String  @default("pool.ntp.org") // NTP server address
  ntpTimezone        String  @default("Asia/Jakarta") // Server timezone
  ntpSyncInterval    Int     @default(3600)  // Sync interval in seconds (default 1 hour)
  ntpLastSync        DateTime? // Last successful NTP sync time
  ntpOffset          Int     @default(0)     // Time offset in milliseconds
  
  // Email SMTP Settings
  emailEnabled       Boolean @default(false) // Enable email notifications
  smtpHost           String? // SMTP server hostname
  smtpPort           Int     @default(587)   // SMTP port
  smtpSecure         Boolean @default(false) // Use SSL/TLS
  smtpUser           String? // SMTP username
  smtpPass           String? // SMTP password (encrypted)
  smtpFrom           String? // Default sender email
  adminEmail         String? // Admin email for notifications
  
  // Check-in Photo Settings
  checkinPhotoEnabled Boolean @default(false) // Enable photo capture during check-in

  // Auto Backup Settings
  autoBackupEnabled   Boolean   @default(false)
  autoBackupInterval  Int       @default(7)     // Interval in days
  lastAutoBackup      DateTime?                 // Timestamp of last auto backup

  // Sunday Auto-Holiday Settings
  sundayAutoHoliday   Boolean   @default(false) // Automatically mark all Sundays as holidays

  // Canteen Check-in Enforcement
  enforceCanteenCheckin Boolean @default(false) // Require canteen selection at check-in station

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Audit Log for comprehensive activity tracking
enum AuditAction {
  // Auth actions
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  
  // CRUD actions
  CREATE
  UPDATE
  DELETE
  
  // Order actions
  ORDER_CREATED
  ORDER_CANCELLED
  ORDER_CHECKIN
  ORDER_NOSHOW
  
  // Blacklist actions
  USER_BLACKLISTED
  USER_UNBLOCKED
  STRIKES_RESET
  
  // System actions
  SETTINGS_UPDATE
  NTP_SYNC
  IMPORT_DATA
  EXPORT_DATA
  
  // Other
  VIEW
  SEARCH
  OTHER
}

model AuditLog {
  id          String      @id @default(uuid())
  timestamp   DateTime    @default(now())
  
  // Who performed the action
  userId      String?     // Can be null for system actions or failed logins
  userName    String?     // Denormalized for quick display
  userRole    String?     // Role at time of action
  
  // What action was performed
  action      AuditAction
  
  // What entity was affected
  entity      String      // e.g., "User", "Order", "Shift", "Settings"
  entityId    String?     // ID of the affected entity
  entityName  String?     // Denormalized name for quick display
  
  // Change details
  oldValue    Json?       // Previous state (for updates/deletes)
  newValue    Json?       // New state (for creates/updates)
  changes     Json?       // Summary of what changed
  
  // Request context
  ipAddress   String?
  userAgent   String?
  requestPath String?     // API endpoint called
  requestMethod String?   // GET, POST, PUT, DELETE
  
  // Additional metadata
  metadata    Json?       // Any additional context
  description String?     // Human-readable description
  
  // Status
  success     Boolean     @default(true)
  errorMessage String?    // If action failed
  
  @@index([timestamp])
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([entityId])
  @@index([success])
  // Composite index for audit queries
  @@index([timestamp, entity])  // Common audit log filtering
}

// Holiday calendar for blocking food orders on specific dates
model Holiday {
  id          String   @id @default(uuid())
  date        DateTime @db.Date // The date of the holiday
  name        String   // Holiday name (e.g., "Idul Fitri", "Natal")
  description String?  // Optional description
  shiftId     String?  // If null = fullday, if set = only this shift is blocked
  shift       Shift?   @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, shiftId]) // Unique per date + shift combo
  @@index([date])
  @@index([isActive])
  @@index([shiftId])
}

// Message model for customer complaints and cancellation reasons
model Message {
  id          String      @id @default(uuid())
  orderId     String?     // Optional link to order (for complaints after ordering)
  shiftId     String      // Which shift the message is about
  userId      String      // Who submitted the message
  type        MessageType
  content     String      // The actual complaint/reason text
  orderDate   DateTime    // Date the order was for
  createdAt   DateTime    @default(now())

  order       Order?      @relation(fields: [orderId], references: [id], onDelete: SetNull)
  shift       Shift       @relation(fields: [shiftId], references: [id])
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([shiftId])
  @@index([orderId])
  @@index([type])
  @@index([orderDate])
}

enum AnnouncementType {
  ANNOUNCEMENT
  AGREEMENT
}

// Announcement model for admin broadcasts to users
model Announcement {
  id          String           @id @default(uuid())
  title       String           // Announcement title
  type        AnnouncementType @default(ANNOUNCEMENT)
  content     String           // Announcement content/message
  priority    String           @default("normal") // "low", "normal", "high", "urgent"
  isActive    Boolean   @default(true)
  expiresAt   DateTime? // Optional expiration date
  createdById String    // Admin who created this
  createdBy   User      @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
  @@index([createdAt])
  @@index([expiresAt])
}
