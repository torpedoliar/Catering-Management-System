import { useState, useEffect, useCallback, useRef } from 'react';
import { api } from '../../contexts/AuthContext';
import { useSSE, useSSERefresh, ORDER_EVENTS } from '../../contexts/SSEContext';
import { ScanLine, Search, CheckCircle2, AlertCircle, Loader2, Wifi, X, User as UserIcon, Building2, Briefcase, Clock } from 'lucide-react';
import toast from 'react-hot-toast';


interface CheckInResult {
    success: boolean;
    message: string;
    order?: {
        id: string;
        status: string;
        checkInTime?: Date | string;
        user: { name: string; externalId: string; company: string; department: string };
        shift: { name: string };
    };
    checkInBy?: string;
    checkInTime?: Date | string;
}

interface SuccessPopupProps {
    show: boolean;
    data: CheckInResult | null;
    onClose: () => void;
}

function SuccessPopup({ show, data, onClose }: SuccessPopupProps) {
    const [countdown, setCountdown] = useState(5);

    useEffect(() => {
        if (show && countdown > 0) {
            const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
            return () => clearTimeout(timer);
        } else if (countdown === 0) {
            onClose();
        }
    }, [show, countdown, onClose]);

    useEffect(() => {
        if (show) {
            setCountdown(5);
                    >
                <X className="w-6 h-6" />
                    </button >
                </div >

                {/* User Info */ }
                < div className = "space-y-4 mb-6" >
                    <div className="p-4 rounded-lg bg-slate-800/50 border border-slate-700/50">
                        <div className="flex items-center gap-2 text-slate-400 text-sm mb-2">
                            <UserIcon className="w-4 h-4" />
                            <span>Informasi Pengguna</span>
                        </div>
                        <p className="text-xl font-bold text-white">{data.order.user.name}</p>
                        <p className="text-sm text-cyan-400">ID: {data.order.user.externalId}</p>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div className="p-4 rounded-lg bg-slate-800/50 border border-slate-700/50">
                            <div className="flex items-center gap-2 text-slate-400 text-xs mb-1">
                                <Building2 className="w-3.5 h-3.5" />
                                <span>Perusahaan</span>
                            </div>
                            <p className="text-sm font-semibold text-white">{data.order.user.company || '-'}</p>
                        </div>
                        <div className="p-4 rounded-lg bg-slate-800/50 border border-slate-700/50">
                            <div className="flex items-center gap-2 text-slate-400 text-xs mb-1">
                                <Briefcase className="w-3.5 h-3.5" />
                                <span>Departemen</span>
                            </div>
                            <p className="text-sm font-semibold text-white">{data.order.user.department || '-'}</p>
                        </div>
                    </div>

                    <div className="p-4 rounded-lg bg-emerald-500/10 border border-emerald-500/30">
                        <div className="flex items-center gap-2 text-emerald-400 text-sm mb-2">
                            <Clock className="w-4 h-4" />
                            <span>Waktu Check-In</span>
                        </div>
                        <p className="text-sm font-semibold text-white mb-1">{formattedTime}</p>
                        <div className="flex items-center justify-between text-xs">
                            <span className="text-slate-400">Shift: <span className="text-cyan-400 font-medium">{data.order.shift.name}</span></span>
                            <span className="text-slate-400">Admin: <span className="text-purple-400 font-medium">{data.checkInBy || 'Admin'}</span></span>
                        </div>
                    </div>
                </div >

                {/* Auto-close countdown */ }
                < div className = "text-center" >
                    <p className="text-sm text-slate-400">
                        Menutup otomatis dalam <span className="text-white font-bold">{countdown}</span> detik
                    </p>
                    <div className="mt-2 w-full h-1 bg-slate-700 rounded-full overflow-hidden">
                        <div
                            className="h-full bg-gradient-to-r from-emerald-500 to-cyan-500 transition-all duration-1000"
                            style={{ width: `${(countdown / 5) * 100}%` }}
                        />
                    </div>
                </div >
            </div >
        </div >
    );
}

export default function CheckInPage() {
    const { isConnected, connectedClients } = useSSE();
    const [searchInput, setSearchInput] = useState('');
    const [isProcessing, setIsProcessing] = useState(false);
    const [showSuccessPopup, setShowSuccessPopup] = useState(false);
    const [successData, setSuccessData] = useState<CheckInResult | null>(null);
    const [lastError, setLastError] = useState<string | null>(null);
    const [todayStats, setTodayStats] = useState({ total: 0, checkedIn: 0, pending: 0 });
    const [lastCheckInTime, setLastCheckInTime] = useState<number>(0);
    const inputRef = useRef<HTMLInputElement>(null);

    const loadStats = useCallback(async () => {
        try {
            const res = await api.get('/api/orders/stats/today');
            setTodayStats({
                total: res.data.total,
                checkedIn: res.data.pickedUp,
                pending: res.data.pending,
            });
        } catch (error) {
            console.error('Failed to load stats:', error);
        }
    }, []);

    useEffect(() => {
        loadStats();
    }, [loadStats]);

    useSSERefresh(ORDER_EVENTS, loadStats);

    const handleCheckIn = async (method: 'manual' | 'qr') => {
        if (!searchInput.trim()) {
            toast.error('Masukkan ID Karyawan, Nama, atau QR Code');
            return;
        }

        setIsProcessing(true);
        setLastError(null);

        try {
            let res;
            if (method === 'qr') {
                res = await api.post('/api/orders/checkin/qr', { qrCode: searchInput.trim() });
            } else {
                const isId = /^[A-Z0-9]+$/i.test(searchInput.trim());
                const payload = isId
                    ? { externalId: searchInput.trim() }
                    : { name: searchInput.trim() };
                res = await api.post('/api/orders/checkin/manual', payload);
            }

            const result: CheckInResult = {
                success: true,
                message: res.data.message,
                order: res.data.order,
                checkInBy: res.data.checkInBy,
                checkInTime: res.data.checkInTime
            };

            // Check if rapid check-in (within 5 seconds)
            const now = Date.now();
            const isRapidCheckIn = now - lastCheckInTime < 5000;

            if (isRapidCheckIn) {
                // Rapid check-in: just show toast, no popup
                toast.success(`✓ ${result.order?.user.name} - ${result.order?.shift.name}`, {
                    duration: 2000,
                    icon: '✅'
                });
            } else {
                // Normal check-in: show full popup
                setSuccessData(result);
                setShowSuccessPopup(true);
            }

            setLastCheckInTime(now);
            setSearchInput(''); // Clear for next entry
            loadStats();

            // Keep focus on input for rapid check-in
            setTimeout(() => {
                inputRef.current?.focus();
            }, 100);
        } catch (error: any) {
            const message = error.response?.data?.error || 'Check-in gagal';

            // Check if user already checked in
            if (message.includes('sudah di-check in sebelumnya') && error.response?.data?.order) {
                const alreadyCheckedOrder = error.response.data.order;

                // Show warning popup for already checked-in
                const warningResult: CheckInResult = {
                    success: false,
                    message: 'Sudah Ambil Makan',
                    order: alreadyCheckedOrder,
                    checkInTime: alreadyCheckedOrder.checkInTime,
                    checkInBy: 'Unknown' // Backend doesn't store who did check-in
                };

                setSuccessData(warningResult);
                setShowSuccessPopup(true);
                setSearchInput('');

                toast.error('User sudah check-in sebelumnya', {
                    icon: '⚠️',
                    duration: 3000
                });
            } else {
                setLastError(message);
                toast.error(message);
            }

            // Keep focus on input even on error
            setTimeout(() => {
                inputRef.current?.focus();
            }, 100);
        } finally {
            setIsProcessing(false);
        }
    };

    const handleKeyPress = (e: React.KeyboardEvent, method: 'manual' | 'qr') => {
        if (e.key === 'Enter') {
            handleCheckIn(method);
        }
    };

    return (
        <div className="max-w-2xl mx-auto space-y-6 animate-fade-in">
            {/* SSE Status Banner */}
            <div className={`flex items-center justify-between p-3 rounded-xl ${isConnected ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-red-500/10 border border-red-500/30'
                }`}>
                <div className="flex items-center gap-2">
                    <Wifi className={`w-4 h-4 ${isConnected ? 'text-emerald-400' : 'text-red-400'}`} />
                    <span className={`text-sm font-medium ${isConnected ? 'text-emerald-400' : 'text-red-400'}`}>
                        {isConnected ? 'Sinkronisasi real-time aktif' : 'Menyambung kembali...'}
                    </span>
                </div>
                <span className="text-xs text-slate-400">{connectedClients} klien terhubung</span>
            </div>

            {/* Stats */}
            <div className="grid grid-cols-3 gap-4">
                <div className="glass-dark rounded-xl p-6 text-center">
                    <p className="text-slate-400 text-sm">Total Pesanan</p>
                    <p className="text-3xl font-bold text-white mt-1">{todayStats.total}</p>
                </div>
                <div className="glass-dark rounded-xl p-6 text-center">
                    <p className="text-slate-400 text-sm">Sudah Diambil</p>
                    <p className="text-3xl font-bold text-emerald-400 mt-1">{todayStats.checkedIn}</p>
                </div>
                <div className="glass-dark rounded-xl p-6 text-center">
                    <p className="text-slate-400 text-sm">Pending</p>
                    <p className="text-3xl font-bold text-amber-400 mt-1">{todayStats.pending}</p>
                </div>
            </div>

            {/* Check-in Card */}
            <div className="glass-dark rounded-xl p-8">
                <h2 className="text-2xl font-bold text-white mb-2">Check-In Pengambilan Makanan</h2>
                <p className="text-slate-400 text-sm mb-6">Masukkan ID Karyawan, Nama, atau scan QR Code</p>

                {/* Single Input */}
                <div className="relative mb-6">
                    <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" />
                    <input
                        ref={inputRef}
                        type="text"
                        placeholder="ID Karyawan / Nama / QR Code..."
                        value={searchInput}
                        onChange={(e) => setSearchInput(e.target.value)}
                        onKeyPress={(e) => handleKeyPress(e, 'manual')}
                        autoFocus
                        className="input-field pl-12 text-lg h-16 text-white"
                        disabled={isProcessing}
                    />
                </div>

                {/* Action Buttons */}
                <div className="grid grid-cols-2 gap-4">
                    {/* Manual Check-In - Primary */}
                    <button
                        onClick={() => handleCheckIn('manual')}
                        disabled={isProcessing || !searchInput.trim()}
                        className="btn-success h-14 flex items-center justify-center gap-3 text-base font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {isProcessing ? (
                            <>
                                <Loader2 className="w-5 h-5 animate-spin" />
                                Memproses...
                            </>
                        ) : (
                            <>
                                <CheckCircle2 className="w-5 h-5" />
                                Ambil Makan (Manual)
                            </>
                        )}
                    </button>

                    {/* QR Scan - Secondary */}
                    <button
                        onClick={() => handleCheckIn('qr')}
                        disabled={isProcessing || !searchInput.trim()}
                        className="h-14 px-6 rounded-lg bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-semibold hover:from-cyan-500 hover:to-blue-500 transition-all flex items-center justify-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {isProcessing ? (
                            <>
                                <Loader2 className="w-5 h-5 animate-spin" />
                                Memproses...
                            </>
                        ) : (
                            <>
                                <ScanLine className="w-5 h-5" />
                                Scan QR
                            </>
                        )}
                    </button>
                </div>

                {/* Last Error */}
                {lastError && (
                    <div className="mt-6 p-4 rounded-xl bg-red-500/10 border border-red-500/30">
                        <div className="flex items-start gap-3">
                            <AlertCircle className="w-6 h-6 text-red-400 flex-shrink-0" />
                            <div>
                                <p className="font-medium text-red-400">{lastError}</p>
                                <p className="text-xs text-slate-400 mt-1">Silakan coba lagi atau hubungi admin</p>
                            </div>
                        </div>
                    </div>
                )}

                {/* Instructions */}
                <div className="mt-6 p-4 rounded-lg bg-slate-800/30 border border-slate-700/50">
                    <p className="text-sm text-slate-400 leading-relaxed">
                        <strong className="text-white">Petunjuk:</strong><br />
                        • Untuk <span className="text-emerald-400">manual check-in</span>, ketik ID atau nama karyawan<br />
                        • Untuk <span className="text-cyan-400">QR check-in</span>, scan atau ketik kode QR<br />
                        • Tekan <kbd className="px-2 py-0.5 bg-slate-700 rounded text-xs">Enter</kbd> untuk check-in manual cepat
                    </p>
                </div>
            </div>

            {/* Success Popup */}
            <SuccessPopup
                show={showSuccessPopup}
                data={successData}
                onClose={() => {
                    setShowSuccessPopup(false);
                    setSuccessData(null);
                }}
            />
        </div>
    );
}
